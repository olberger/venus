#!/usr/bin/make -f

# This file is part of the planet-venus package.

# Copyright (C) 2007 Noah Slater <nslater@bytesexual.org>.

# Copying and distribution of this file, with or without modification, are
# permitted in any medium without royalty provided the copyright notice and this
# notice are preserved.

# Makefile used by dpkg-buildpackage to create a deb archive.

include /usr/share/cdbs/1/rules/buildcore.mk
include /usr/share/cdbs/1/rules/debhelper.mk
include /usr/share/cdbs/1/rules/simple-patchsys.mk

DEB_COMPRESS_EXCLUDE = .png .svg

REPOSITORY_URI = http://intertwingly.net/code/venus/

PACKAGE_NAME = planet-venus
PACKAGE_VERSION = $(shell dpkg-parsechangelog | sed -rne 's/^Version: .*~bzr([^-]+).*/\1/p')
PACKAGE_DIRECTORY=$(PACKAGE_NAME)-0~bzr$(PACKAGE_VERSION).orig
PACKAGE_FILENAME=$(PACKAGE_NAME)_0~bzr$(PACKAGE_VERSION).orig.tar.gz

clean::
	rm -f planet.sed.py

# XXX: The bundled feedparser.py is a pre-release version so we can't depend on
# XXX: the standard packaged version. The other three bundled modules might be
# XXX: nice as external packages, one day.

common-install-prehook-impl::
	DEBIAN_VERSION=$(shell dpkg-parsechangelog | grep Version | sed "s/\w*: //"); \
	sed "s/@version@/$${DEBIAN_VERSION}/" planet.py > planet.sed.py
	chmod 755 planet.sed.py
	help2man -N -n "an aggregate feed generator" ./planet.sed.py > planet.1
	cp -R docs debian/planet-venus/usr/share/doc/planet-venus/html
	cp -R examples debian/planet-venus/usr/share/planet-venus/example
	chmod 755 debian/planet-venus/usr/share/planet-venus/example/filters/guess-language/guess-language.py
	chmod 755 debian/planet-venus/usr/share/planet-venus/example/filters/guess-language/trigram.py
	cp -R filters debian/planet-venus/usr/share/planet-venus/filter
	cp -R planet.sed.py debian/planet-venus/usr/bin/planet
	cp -R themes debian/planet-venus/usr/share/planet-venus/theme
	rm -f debian/planet-venus/usr/share/planet-venus/theme/diveintomark/LICENCE
	cp -R planet debian/planet-venus/usr/share/python-support/planet-venus
	rm -fr debian/planet-venus/usr/share/python-support/planet-venus/planet/vendor/htmltmpl.py
	rm -fr debian/planet-venus/usr/share/python-support/planet-venus/planet/vendor/html5lib
	rm -fr debian/planet-venus/usr/share/python-support/planet-venus/planet/vendor/httplib2
	cp -R debian/planet.ini debian/planet-venus/usr/share/planet-venus/example/debian.ini
	cp debian/binary.lintian-overrides debian/planet-venus/usr/share/lintian/overrides/planet-venus
	cp debian/linda-overrides debian/planet-venus/usr/share/linda/overrides/planet-venus

binary-install/planet-venus::
	dh_pysupport -pplanet-venus -X example -X filter

get-orig-source:
	bzr export -r $(PACKAGE_VERSION) $(PACKAGE_FILENAME) $(REPOSITORY_URI)

.PHONY: get-orig-source
